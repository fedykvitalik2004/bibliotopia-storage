# Dependency Review Action
name: 'Dependency review'
on:
  pull_request:
    branches: [ "main" ]
permissions:
  contents: read
  pull-requests: write
jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      - id: review
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always
          fail-on-severity: moderate       
      - name: Show all outputs safely
        env:
          COMMENT_CONTENT: ${{ steps.review.outputs.comment-content }}
          DEPENDENCY_CHANGES: ${{ steps.review.outputs.dependency-changes }}
          VULNERABLE_CHANGES: ${{ steps.review.outputs.vulnerable-changes }}
          INVALID_LICENSE_CHANGES: ${{ steps.review.outputs.invalid-license-changes }}
          DENIED_CHANGES: ${{ steps.review.outputs.denied-changes }}
        run: |
          echo "=== COMMENT CONTENT ==="
          echo "$COMMENT_CONTENT"
          echo
          echo "=== ALL DEPENDENCY CHANGES ==="
          echo "$DEPENDENCY_CHANGES" | jq
          echo
          echo "=== VULNERABLE CHANGES ==="
          echo "$VULNERABLE_CHANGES" | jq
          echo
          echo "=== INVALID LICENSE CHANGES ==="
          echo "$INVALID_LICENSE_CHANGES" | jq
          echo
          echo "=== DENIED CHANGES ==="
          echo "$DENIED_CHANGES" | jq
      - name: Post PR Comment (Formatted)
        if: ${{ always() }}
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <h2>Dependency Review Results</h2>
            <p>The following issues were detected in this PR:</p>

            **Vulnerable Dependencies:**
            ${{ steps.review.outputs.vulnerable-changes }}

            **Invalid License Changes:**
            ${{ steps.review.outputs.invalid-license-changes }}

            **Denied Changes:**
            ${{ steps.review.outputs.denied-changes }}

            <p>Please address these issues before merging.</p>
    
